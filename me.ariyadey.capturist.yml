app-id: me.ariyadey.capturist
command: capturist
runtime: org.gnome.Platform
runtime-version: "48"
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node24
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --share=network
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.me_ariyadey_capturist.SingleInstance
  - --own-name=org.me_ariyadey_capturist.SingleInstance
  # For "Launch on Startup"
  - --filesystem=xdg-config/autostart:create
  # For the tray icon to be visible in some desktop environments (e.g., KDE/Cinnamon)
  - --filesystem=xdg-run/tray-icon:create
build-options:
  append-path: /usr/lib/sdk/rust-stable/bin:/usr/lib/sdk/node24/bin
modules:
  - name: libdbusmenu
    buildsystem: autotools
    sources:
      - type: archive
        url: https://launchpad.net/libdbusmenu/16.04/16.04.0/+download/libdbusmenu-16.04.0.tar.gz
        sha256: b9cc4a2acd74509435892823607d966d424bd9ad5d0b00938f27240a1bfa878a
    config-opts:
      - --with-gtk=3
      - --disable-dumper

  - name: libayatana-indicator
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/AyatanaIndicators/libayatana-indicator.git
        tag: 0.9.4
    config-opts:
      - --with-gtk=3

  - name: libayatana-appindicator
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/AyatanaIndicators/libayatana-appindicator.git
        tag: 0.5.94
    config-opts:
      - --with-gtk=3

  - name: capturist
    buildsystem: simple
    sources:
      - type: dir
        path: .
    # language=BASH
    build-commands:
      - |
        set -eu

        if [ ! -f "capturist.deb" ]; then
            echo "--- No pre-built deb found, building from source... ---"
            echo "Node version: $(node --version)"
            echo "npm version: $(npm --version)"
            echo "Rust version: $(rustc --version)"

            npm ci --no-audit --no-fund
            npm run tauri build -- --config src-tauri/tauri.snap.conf.json
            mv src-tauri/target/release/bundle/deb/*.deb capturist.deb
        fi

        ar x capturist.deb
        tar -xvf data.tar.gz
        cp -r usr/* /app/

        APP_ID="me.ariyadey.capturist"
        APP_NAME="capturist"
        APP_APPLICATIONS_DIR="/app/share/applications"
        APP_ICON_DIR="/app/share/icons/hicolor/128x128/apps"

        # Rename files to match Flatpak app-id conventions
        install -D -m 644 ${APP_ICON_DIR}/${APP_NAME}.png ${APP_ICON_DIR}/${APP_ID}.png
        install -D -m 644 ${APP_APPLICATIONS_DIR}/Capturist.desktop "${APP_APPLICATIONS_DIR}/${APP_ID}.desktop"

        # Fix desktop file to match the Flatpak app-id and icon conventions
        sed -i "s|Icon=${APP_NAME}|Icon=${APP_ID}|" "${APP_APPLICATIONS_DIR}/${APP_ID}.desktop"
        sed -i "s|^Exec=${APP_NAME} %u$|Exec=${APP_NAME} --gapplication-service %u|" "${APP_APPLICATIONS_DIR}/${APP_ID}.desktop"

        # Patch metainfo to match the renamed desktop file
        sed -i 's|Capturist.desktop|me.ariyadey.capturist.desktop|' /app/share/metainfo/me.ariyadey.capturist.metainfo.xml
